<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .ai-shimmer {
            background: linear-gradient(90deg, #6366f1, #a855f7, #6366f1);
            background-size: 200% auto;
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer {
            to { background-position: 200% center; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-12">

    <!-- Header & Dashboard -->
    <header class="bg-indigo-600 text-white pt-8 pb-24 px-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold tracking-tight">ðŸ’° WealthWatch</h1>
            <div id="user-display" class="text-sm font-medium opacity-90 bg-indigo-500 px-3 py-1 rounded-full">
                Syncing...
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white/10 p-6 rounded-2xl backdrop-blur-md border border-white/20">
                <p class="text-indigo-100 text-sm mb-1 uppercase tracking-wider font-semibold">Total Balance</p>
                <p id="total-balance" class="text-3xl font-bold">â‚¹0.00</p>
            </div>
            <div class="bg-emerald-500/20 p-6 rounded-2xl backdrop-blur-md border border-emerald-500/30">
                <p class="text-emerald-100 text-sm mb-1 uppercase tracking-wider font-semibold">Income</p>
                <p id="total-income" class="text-3xl font-bold text-emerald-300">+â‚¹0.00</p>
            </div>
            <div class="bg-rose-500/20 p-6 rounded-2xl backdrop-blur-md border border-rose-500/30">
                <p class="text-rose-100 text-sm mb-1 uppercase tracking-wider font-semibold">Expenses</p>
                <p id="total-expense" class="text-3xl font-bold text-rose-300">-â‚¹0.00</p>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 -mt-12 space-y-6">
        
        <!-- AI Smart Entry -->
        <section class="glass-card rounded-2xl shadow-xl p-6 border-2 border-indigo-100">
            <h2 class="text-sm font-bold text-indigo-600 mb-3 flex items-center uppercase tracking-widest">
                <span class="mr-2">âœ¨</span> AI Quick Add
            </h2>
            <div class="flex gap-2">
                <input type="text" id="ai-input" placeholder="e.g. 'Got â‚¹500 pocket money' or 'Spent 150 on petrol'" 
                       class="flex-1 p-3 bg-indigo-50 border border-indigo-100 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                <button id="ai-add-btn" class="ai-shimmer text-white font-bold px-6 py-3 rounded-xl shadow-lg hover:opacity-90 transition-all active:scale-95 whitespace-nowrap">
                    âœ¨ Magic Add
                </button>
            </div>
        </section>

        <!-- Input Form -->
        <section class="glass-card rounded-2xl shadow-xl p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">âž•</span> Manual Entry
            </h2>
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Type</label>
                    <select id="type" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description</label>
                    <input type="text" id="desc" placeholder="e.g. Rent, Salary" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Amount (â‚¹)</label>
                    <input type="number" step="0.01" id="amount" placeholder="0.00" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                </div>
                <div class="flex items-end">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 transition-all active:scale-95">
                        Add Record
                    </button>
                </div>
            </form>
        </section>

        <!-- AI Insights Section -->
        <section id="ai-insights-container" class="hidden glass-card rounded-2xl shadow-xl p-6 bg-gradient-to-br from-indigo-50 to-white border-indigo-200">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-indigo-900 flex items-center">
                    <span class="mr-2">ðŸ’¡</span> AI Financial Insights
                </h2>
                <button id="close-insights" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div id="ai-insights-content" class="text-indigo-800 text-sm leading-relaxed space-y-2">
                <!-- AI analysis goes here -->
            </div>
        </section>

        <!-- Transaction List -->
        <section class="glass-card rounded-2xl shadow-xl p-6 min-h-[300px]">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <h2 class="text-lg font-semibold text-gray-800">History</h2>
                    <button id="ai-analyze-btn" class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold hover:bg-indigo-200 transition-colors">
                        âœ¨ Get AI Insights
                    </button>
                </div>
                <button id="clear-btn" class="text-xs text-rose-500 hover:underline font-medium">Clear All</button>
            </div>
            
            <div id="loading-state" class="py-12 text-center text-gray-400">
                <div class="animate-spin inline-block w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full mb-2"></div>
                <p>Loading your finances...</p>
            </div>

            <ul id="list" class="space-y-3">
                <!-- Transactions injected here -->
            </ul>
            
            <div id="empty-state" class="hidden py-12 text-center">
                <p class="text-gray-400">No transactions recorded yet.</p>
            </div>
        </section>
    </main>

    <!-- Error Toast -->
    <div id="error-toast" class="fixed bottom-4 right-4 bg-rose-600 text-white px-6 py-3 rounded-xl shadow-2xl transform translate-y-20 transition-transform duration-300 pointer-events-none">
        An error occurred. Please try again.
    </div>

    <script>
        // Use compat versions for better compatibility in this environment
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Firebase Configuration
                const firebaseConfig = JSON.parse(__firebase_config);
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'expense-tracker-app';
                const apiKey = ""; // Managed by environment

                // DOM Elements
                const balanceEl = document.getElementById('total-balance');
                const incomeEl = document.getElementById('total-income');
                const expenseEl = document.getElementById('total-expense');
                const listEl = document.getElementById('list');
                const form = document.getElementById('transaction-form');
                const descInput = document.getElementById('desc');
                const amountInput = document.getElementById('amount');
                const typeInput = document.getElementById('type');
                const userDisplay = document.getElementById('user-display');
                const loadingState = document.getElementById('loading-state');
                const emptyState = document.getElementById('empty-state');
                const clearBtn = document.getElementById('clear-btn');
                const errorToast = document.getElementById('error-toast');
                
                // AI Elements
                const aiInput = document.getElementById('ai-input');
                const aiAddBtn = document.getElementById('ai-add-btn');
                const aiAnalyzeBtn = document.getElementById('ai-analyze-btn');
                const aiInsightsContainer = document.getElementById('ai-insights-container');
                const aiInsightsContent = document.getElementById('ai-insights-content');
                const closeInsights = document.getElementById('close-insights');

                let currentUser = null;
                let currentTransactions = [];

                // Utility: Show Error
                function showError(msg) {
                    errorToast.textContent = msg;
                    errorToast.classList.remove('translate-y-20');
                    setTimeout(() => errorToast.classList.add('translate-y-20'), 4000);
                }

                // Authentication (Rule 3)
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (err) {
                        console.error("Auth failed", err);
                        showError("Connection failed.");
                    }
                };

                initAuth();

                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    if (user) {
                        userDisplay.textContent = `User: ${user.uid.substring(0, 8)}...`;
                        setupDataListener(user.uid);
                    }
                });

                function setupDataListener(uid) {
                    const path = `/artifacts/${appId}/users/${uid}/transactions`;
                    db.collection(path).onSnapshot((snapshot) => {
                        const transactions = [];
                        snapshot.forEach(doc => {
                            transactions.push({ id: doc.id, ...doc.data() });
                        });
                        currentTransactions = transactions;
                        updateUI(transactions);
                        loadingState.classList.add('hidden');
                    }, (error) => {
                        console.error("Firestore error", error);
                        showError("Failed to fetch data.");
                    });
                }

                function updateUI(transactions) {
                    listEl.innerHTML = '';
                    if (transactions.length === 0) emptyState.classList.remove('hidden');
                    else emptyState.classList.add('hidden');

                    let income = 0;
                    let expense = 0;

                    transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(transaction => {
                        const isIncome = transaction.type === 'income';
                        const amt = parseFloat(transaction.amount);
                        if (isIncome) income += amt; else expense += amt;

                        const li = document.createElement('li');
                        li.className = `flex justify-between items-center p-4 bg-white border-l-4 ${isIncome ? 'border-emerald-500' : 'border-rose-500'} rounded-xl shadow-sm hover:shadow-md transition-shadow group`;
                        li.innerHTML = `
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-gray-800">${transaction.description}</p>
                                <p class="text-xs text-gray-400 capitalize">${transaction.type}</p>
                            </div>
                            <div class="text-right flex items-center gap-4">
                                <span class="font-bold ${isIncome ? 'text-emerald-600' : 'text-rose-600'}">
                                    ${isIncome ? '+' : '-'}â‚¹${amt.toFixed(2)}
                                </span>
                                <button class="delete-transaction text-gray-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity p-1" data-id="${transaction.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        `;
                        listEl.appendChild(li);
                    });

                    // Delegation for delete buttons
                    document.querySelectorAll('.delete-transaction').forEach(btn => {
                        btn.onclick = () => deleteTransaction(btn.dataset.id);
                    });

                    const balance = income - expense;
                    balanceEl.textContent = `${balance < 0 ? '-' : ''}â‚¹${Math.abs(balance).toFixed(2)}`;
                    incomeEl.textContent = `+â‚¹${income.toFixed(2)}`;
                    expenseEl.textContent = `-â‚¹${expense.toFixed(2)}`;
                }

                async function callGemini(prompt, isJson = false) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: isJson ? { responseMimeType: "application/json" } : {}
                    };
                    let delay = 1000;
                    for (let i = 0; i < 5; i++) {
                        try {
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (!response.ok) throw new Error('Retry');
                            const data = await response.json();
                            return data.candidates?.[0]?.content?.parts?.[0]?.text;
                        } catch (e) {
                            if (i === 4) throw e;
                            await new Promise(r => setTimeout(r, delay));
                            delay *= 2;
                        }
                    }
                }

                aiAddBtn.addEventListener('click', async () => {
                    const text = aiInput.value.trim();
                    if (!text || !currentUser) return;
                    aiAddBtn.disabled = true;
                    aiAddBtn.textContent = "âœ¨ Thinking...";
                    const systemPrompt = `You are a financial assistant. Extract transaction details from user text. Currency: INR. Return JSON: {description: string, amount: number, type: "income"|"expense"}. User: "${text}"`;
                    try {
                        const resultText = await callGemini(systemPrompt, true);
                        const data = JSON.parse(resultText);
                        if (data.description && data.amount) {
                            await db.collection(`/artifacts/${appId}/users/${currentUser.uid}/transactions`).add({
                                ...data, createdAt: new Date().toISOString()
                            });
                            aiInput.value = "";
                        }
                    } catch (err) { showError("AI error. Try manual entry."); }
                    finally { aiAddBtn.disabled = false; aiAddBtn.textContent = "âœ¨ Magic Add"; }
                });

                aiAnalyzeBtn.addEventListener('click', async () => {
                    if (currentTransactions.length === 0) return showError("Add some transactions first!");
                    aiAnalyzeBtn.disabled = true;
                    aiAnalyzeBtn.textContent = "âœ¨ Analyzing...";
                    const summary = currentTransactions.map(t => `${t.type}: ${t.description} (â‚¹${t.amount})`).join(', ');
                    const prompt = `Analyze these transactions (INR): ${summary}. Provide 3 bullet points on habits and 1 saving tip. Brief & emoji-friendly.`;
                    try {
                        const insights = await callGemini(prompt);
                        aiInsightsContent.innerHTML = insights.replace(/\n/g, '<br>');
                        aiInsightsContainer.classList.remove('hidden');
                    } catch (err) { showError("Insight error."); }
                    finally { aiAnalyzeBtn.disabled = false; aiAnalyzeBtn.textContent = "âœ¨ Get AI Insights"; }
                });

                closeInsights.onclick = () => aiInsightsContainer.classList.add('hidden');

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!currentUser) return;
                    try {
                        await db.collection(`/artifacts/${appId}/users/${currentUser.uid}/transactions`).add({
                            description: descInput.value,
                            amount: parseFloat(amountInput.value),
                            type: typeInput.value,
                            createdAt: new Date().toISOString()
                        });
                        form.reset();
                    } catch (err) { showError("Error adding record."); }
                });

                const deleteTransaction = async (id) => {
                    if (!currentUser) return;
                    try {
                        await db.doc(`/artifacts/${appId}/users/${currentUser.uid}/transactions/${id}`).delete();
                    } catch (err) { showError("Error deleting item."); }
                };

                clearBtn.onclick = async () => {
                    if (!currentUser || !confirm('Clear all?')) return;
                    try {
                        const snap = await db.collection(`/artifacts/${appId}/users/${currentUser.uid}/transactions`).get();
                        const batch = db.batch();
                        snap.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    } catch (err) { showError("Error clearing data."); }
                };
            } catch (globalError) {
                console.error("Initialization error", globalError);
            }
        });
    </script>
</body>
</html>